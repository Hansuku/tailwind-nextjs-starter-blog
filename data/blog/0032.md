---
title: Eval æ‹œæ‹œğŸ‘‹ğŸ»ï¼æ‰‹æ‘¸æ‰‹æ•™ä½ å®ç°å†™ä¸€ä¸ªASTæ•°å®ç°å…¬å¼è§£æå¼•æ“
tags: ['code']
authors: ['default']
layout: PostLayout
date: 2022-07-22 09:00
---

```javascript
IF(AND(OR({self.text\_14}=="-ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨-è¿+é€",{self.text\_14}=="-ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.04"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}*0.97/1.1)-1)* 100,2),IF(AND(OR({self.text\_14}=="-ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨-è¿+é€",{self.text\_14}=="-ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.02"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}*0.97/1.1)-1)* 100,2),IF(AND(OR({self.text\_14}=="-ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨-è¿+é€",{self.text\_14}=="-ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.01"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}*0.97/1.06)-1)* 100,2),IF(AND(OR({self.text\_14}=="+ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨-è¿+é€",{self.text\_14}=="+ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.04"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}/1.1)-1)*100,2),IF(AND(OR({self.text\_14}=="+ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨-è¿+é€",{self.text\_14}=="+ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.02"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}/1.1)-1)* 100,2),IF(AND(OR({self.text\_14}=="+ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨-è¿+é€",{self.text\_14}=="+ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨+è¿+é€"),{self.array\_4.text\_2}=="0.01"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}/1.06)-1)*100,2),IF(AND(OR({self.text\_14}=="-ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨-è¿+é€",{self.text\_14}=="-ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="-ç¨+è¿+é€"),{self.array\_4.text\_2}=="0"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}* 0.97/1.02)-1)*100,2),IF(AND(OR({self.text\_14}=="+ç¨-è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨-è¿+é€",{self.text\_14}=="+ç¨+è¿ï¼ˆè‡ªæï¼‰",{self.text\_14}=="+ç¨+è¿+é€"),{self.array\_4.text\_2}=="0"),ROUND((({self.array\_4.num\_6}-{self.array\_4.num\_2})/({self.array\_4.num\_1}/1.02)-1)* 100,2),0))))))))
```

![](https://cdn.hansuku.com/blog/img/image_yp8HcdNSCD.png)

ä¸çŸ¥é“å¤§å®¶çœ‹åˆ°ä¸Šé¢è¿™ä¸€æ®µæ˜¯ä»€ä¹ˆæƒ³æ³•...è¿™æ˜¯ç”¨æˆ·é€šè¿‡è¡¨å•ç³»ç»Ÿé…ç½®å‡ºæ¥çš„

æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹ä»€ä¹ˆæ˜¯å…¬å¼ï¼Œå¯¹äºæˆ‘ä»¬çš„é¢†åŸŸï¼ˆç±» EXCEL çš„éç§‘å­¦é¢†åŸŸï¼‰å…¬å¼é€šå¸¸ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

- ç®—æœ¯è¡¨è¾¾å¼ï¼ˆExpressionï¼‰

- å‡½æ•°ï¼ˆFunctionï¼‰

- ä»£æ•°ï¼ˆVariableï¼‰

é€šä¿—æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡å¯¹ä¸Šé¢é‚£ä¸€å¤§å¨å½’ç±»è§£æï¼Œåˆ†ææˆä¸Šé¢çš„ä¸‰ç§ç±»å‹ï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„ç»“æœã€‚ä»€ä¹ˆï¼Œä½ çœ‹ä¸æ‡‚ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬ç¿»è¯‘æˆäººè¯ï¼š

- å¦‚æœæˆ‘ä»¬é‡åˆ°äº†`>,<,==,+- \*/`è¿™ç§ç¬¦å·ï¼Œé‚£ä»–å°±æ˜¯è¦æ‰§è¡Œç®—æ•°è¡¨è¾¾å¼

- å¦‚æœæˆ‘ä»¬é‡åˆ°äº† DIVIDEï¼ŒADDï¼ŒSUM è¿™æ ·çš„ä¸œè¥¿ï¼Œé‚£å°±æ˜¯è¦æ‰§è¡Œå‡½æ•°ï¼Œè¿™ä¸ªç‰¹åˆ«å¥½ç†è§£ï¼Œæˆ‘ä»¬ç­‰åŒäº JS é‡Œçš„ Functionï¼š

  ```javascript
  function DIVIDE() {
    // do some things
  }
  ```

- å¦‚æœæˆ‘ä»¬é‡åˆ°äº†`{self.array_4.num_1}`è¿™æ ·çš„ä¸œè¥¿ï¼Œå°±æŠŠä»–ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå»å–å€¼å¹¶è½¬æ¢æˆå¯¹åº”çš„å€¼å³å¯

å¥½ï¼Œç¬¬ä¸€æ­¥ææ¸…æ¥šäº†ï¼Œæˆ‘ä»¬äººæ˜¯èƒ½è¯»æ‡‚è¿™äº›å…¬å¼äº†ï¼Œé‚£ç”µè„‘å‘¢ï¼Ÿ

<img src="https://cdn.hansuku.com/blog/img/image_-w-1hc_6oN.png " width="100px" height="100px" />

æ€»ä½“æ¥è¯´ï¼Œåœ¨å‰ç«¯é¢†åŸŸæƒ³è¦è®©æµè§ˆå™¨ã€Nodejs å»è¯†åˆ«/è¿è¡Œä¸Šé¢é‚£ä¸€å¨ä¸œè¥¿ï¼Œåˆ†ä¸ºä¸¤ç§æ–¹æ¡ˆï¼š

- åŠ¨æ€æ‰§è¡Œï¼ˆevalï¼Œnew Functionï¼‰

- ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰

æ¯”å¦‚ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ new Function æ‰§è¡Œçš„ï¼š

```javascript
const variable = 'var a = 0;var b = 1;'
new Function(`${variable}return a > b`)()
```

ä½¿ç”¨åŠ¨æ€è„šæœ¬å’Œ AST çš„åŒºåˆ«ï¼š

|          | åŠ¨æ€è„šæœ¬                                                                                                                      | AST                                                        |
| -------- | ----------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| ç‰¹æ€§     | å®ç°æˆæœ¬ä½ï¼Œä¾èµ–è¯­è¨€æœ¬èº«çš„èƒ½åŠ›ï¼ŒJS çš„èŒƒå¼æ˜¯ä»€ä¹ˆæ ·çš„ä½ çš„å…¬å¼å°±èƒ½æ‰§è¡Œä»€ä¹ˆï¼ˆä¸»è¦æ˜¯ä¸Šé¢ä¸‰ä¸ªå…¬å¼è¦ç´ ï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªèŒƒå›´æ‰©å±•å¾ˆéš¾ï¼‰ | è‡ªå·±å®ç°å¯¹æ•´ä¸ªè¯­è¨€çš„è§£é‡Šï¼ŒåŸºæœ¬ä¸å­˜åœ¨èƒ½åŠ›é™åˆ¶ï¼Œå®ç°æˆæœ¬é«˜ã€‚ |
| å®‰å…¨æ€§   | ä½                                                                                                                            | é«˜                                                         |
| å…¼å®¹æ‰©å±• | ä½                                                                                                                            | é«˜                                                         |
| æ‰§è¡Œæ•ˆç‡ | é«˜                                                                                                                            | çœ‹ä»£ç æ€ä¹ˆå†™ï¼Œåˆç†çš„ä»£ç æ•ˆç‡ä¸€è‡´é«˜                         |

ä¸‹é¢å¼€å§‹æˆ‘ä»¬çš„æ­£é¢˜ï¼Œç”¨ AST å»è§£æå…¬å¼ã€‚

å¯¹äº AST æ¥è¯´ï¼Œæœ€é‡è¦çš„æ˜¯ä¸¤ä¸ªäº‹æƒ…ï¼š

- å•è¯æ‹†åˆ†ï¼ˆTokenï¼‰

- è¯æ³•è¯­ä¹‰ï¼ˆRuleï¼‰

æ¯”å¦‚åœ¨ new Function çš„æ–¹æ³•é‡Œï¼ŒJS å¼•æ“å¯ä»¥è‡ªå·±å»ç†è§£ DIVIDE è¿™æ ·ä¸€ä¸ªæ ‡è®°ï¼ŒJS å¼•æ“è‡ªå·±ä¼šåœ¨ä½œç”¨åŸŸå†…å¯»æ‰¾æ˜¯å¦å­˜åœ¨è¿™æ ·ä¸€ä¸ªæ–¹æ³•æˆ–è€…å˜é‡ï¼Œå¹¶å°è¯•æ‰§è¡Œä»–ï¼Œä½†åœ¨ AST çš„ä¸–ç•Œé‡Œï¼Œé¦–å…ˆä½ å¾—è®©ä½ çš„è¯­æ³•æ ‘çŸ¥é“ä½ éœ€è¦æ‹†é™¤ä¸€ä¸ª DIVIDE è¿™æ ·çš„æ ‡è®°ï¼Œå¹¶ä¸”ä½ éœ€è¦ç»™ä»–åŒ¹é…å¥½å¯¹åº” DIVIDE è¦åšä»€ä¹ˆï¼Œè¿™æ · AST æ‰èƒ½æ­£å¸¸çš„å®Œæˆä»–çš„ä½¿å‘½ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•æ„å»ºä¸€ä¸ª ASTï¼Ÿå¦‚æœçº¯æ‰‹æ’¸çš„è¯ï¼Œä»£ç é‡å¯ä»¥è¯´æ˜¯éå¸¸ä¹‹å“äººäº†ï¼Œç´¢æ€§å‰ç«¯é¢†åŸŸæœ‰ä¸€äº›éå¸¸å¥½ç”¨çš„è§£ææ„å»ºå·¥å…·ï¼Œæ¯”å¦‚ï¼š

[Chevrotain](https://chevrotain.io/docs/ 'Chevrotain')

[Home - nearley.js - JS Parsing Toolkit](https://nearley.js.org/ 'Home - nearley.js - JS Parsing Toolkit')

å¤§ä½“æ¥è¯´ï¼Œè¿™äº›è§£ææ„å»ºå·¥å…·éƒ½æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›ï¼š

- Token å®šåˆ¶å’Œè§£æï¼Œå³å¯¹ä¸Šé¢é‚£ä¸€å¨ä¸œè¥¿é‡Œçš„å†…å®¹è¿›è¡Œåˆ†ç±»æç‚¼ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬é‡åˆ° DIVIDEã€SUMã€ISOWEEKNUMS è¿™æ ·çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–å½’ç±»ä¸ºå‡½æ•°ï¼Œé‚£æˆ‘å¯ä»¥é€šè¿‡æ­£åˆ™å®šä¹‰è¿™æ ·çš„è§„åˆ™ï¼š

  ```javascript
  export const FunctionMark = createToken({
    name: 'Function',
    pattern: /[A-Za-z_]+[A-Za-z_0-9.]*\(/,
  })
  ```

  ä¸Šé¢æ­£åˆ™ä¸­è¿™ä¸ªæ‹¬å·åœ¨åæ–‡ä¸­ä¼šè§£é‡Šã€‚

- Parser è§£æå’Œæ‰§è¡Œèƒ½åŠ›ï¼Œå³æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ä¸Šé¢å®šä¹‰å¥½çš„ Token è¿›è¡Œè§„åˆ™å®šåˆ¶ï¼Œå¹¶ä¸”å®Œæˆå…¬å¼çš„æ‰§è¡Œè¿”å›ç»“æœã€‚

å¯èƒ½è¿™æ ·çœ‹ä¼šæ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œä½†æ²¡æœ‰å…³ç³»ï¼Œä¸‹é¢ä¼šæ…¢æ…¢è®²æ˜ç™½ï¼Œå†å›è¿‡å¤´æ¥çœ‹è¿™ä¸¤å¥è¯å°±ä¼šæ˜ç™½å•¦ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ [chevrotain](https://github.com/Chevrotain/chevrotain 'chevrotain') è§£ææˆ‘ä»¬çš„å…¬å¼ä»£ç ã€‚ï¼ˆ\*ä¸»è¦æ˜¯ nearley çš„æ–‡æ¡£å†™çš„å¤ªè¾£é¸¡äº†ï¼Œå¯¹æ–°æ‰‹æå…¶ä¸å‹å¥½ï¼Œä¸” chevrotain æ˜¯ç”¨ ts å†™çš„ï¼Œnearley æ˜¯ js å†™çš„ï¼‰ã€‚ä¸ç®¡æ˜¯å“ªä¸ªæ¡†æ¶ï¼Œä»–ä»¬çš„èµ„æ–™éƒ½æ¯”è¾ƒå°‘ï¼Œå…¶ä¸­éƒ¨åˆ†å†…å®¹éå¸¸æ™¦æ¶©éš¾æ‡‚ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€äº›è€å¿ƒæ‰å¯ä»¥ã€‚

å¦å¤–è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µéœ€è¦å…ˆè®²ä¸€ä¸‹ï¼Œä¸Šæ–‡ä¸­æˆ‘ä»¬å¤§é‡çš„æåˆ°äº† ASTï¼Œæ­¤å¤–åœ¨ chevrotain ä¸­æˆ‘ä»¬çœ‹åˆ°è¿˜æœ‰ CSTï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯å•¥ï¼Ÿæœ¬è´¨ä¸Šæ¥è¯´ï¼Œæƒ³è¦æŠŠå…¬å¼ä¹‹ç±»çš„ä¸œè¥¿è¿è¡Œèµ·æ¥ï¼Œæœ€é‡è¦çš„äº‹æƒ…æ˜¯è§£æï¼Œåˆæ­¥è§£æçš„å†…å®¹æˆ‘ä»¬ç§°ä¹‹ä¸º**è§£ææ ‘**ï¼ˆæˆ–è€…å«å…·ä½“è§£ææ ‘ï¼Œä¹Ÿå°±æ˜¯ CSTï¼‰ï¼Œè€Œ AST åˆ™æ˜¯åœ¨å…·ä½“è§£ææ ‘ç²¾ç®€ä»¥åçš„ç»“æœï¼Œå³è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯**ä»å…·ä½“åˆ°æŠ½è±¡**ï¼Œå…³äºè¿™å—å¯ä»¥è¯»ä¸€ä¸‹è¿™ç¯‡

[AST ç³»åˆ—(ä¸€): æŠ½è±¡è¯­æ³•æ ‘ä¸ºä»€ä¹ˆæŠ½è±¡ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/102385477 'ASTç³»åˆ—(ä¸€): æŠ½è±¡è¯­æ³•æ ‘ä¸ºä»€ä¹ˆæŠ½è±¡ - çŸ¥ä¹ (zhihu.com)')

é‡Œé¢å¯¹äºå…·ä½“åˆ°æŠ½è±¡çš„è¿‡ç¨‹è®²çš„æ¯”è¾ƒé€å½»ã€‚

å¥½ï¼Œæˆ‘ä»¬ç†è®ºçŸ¥è¯†å’Œæ­¦å™¨éƒ½æœ‰äº†ï¼Œè¯¥å®æ“ä¸€ä¸‹äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªç®€å•çš„å…¬å¼ï¼š

```javascript
1 + 2
SUM(1, 2)
IF(3 > 2, 1, 2)
```

å›æƒ³ä¸€ä¸‹æˆ‘ä»¬å¼€å§‹è¯´çš„ï¼Œå…¬å¼çš„ç»„æˆä¸‰è¦ç´ ï¼šç®—æ•°è¡¨è¾¾å¼ã€å‡½æ•°ã€ä»£æ•°ï¼ŒåŸºäºè¿™ä¸‰ä¸ªï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥æç‚¼ä¸€äº›è§„åˆ™å‡ºæ¥ï¼Œæ¯”å¦‚ anythings+anythings è¿™æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å®šä¹‰ä¸€ä¸ªè§„åˆ™ï¼Œåªè¦æ‰¾åˆ°åŠ å·ï¼Œå°±æŠŠåŠ å·å·¦å³ä¸¤è¾¹çš„å†…å®¹åŠ èµ·æ¥ï¼Ÿ

æ¯”å¦‚æˆ‘ä»¬è¦è§£æ `1+2`ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ¥å…ˆåšä¸€ä¸‹è¯æ³•æ‹†åˆ†ï¼š

```javascript
export const NumberMark = createToken({
  name: 'NumberMark',
  pattern: /-?\d*\.?\d+/,
})

export const AddMark = createToken({
  name: 'AddMark',
  pattern: /\+/,
})
```

ç„¶åäº¤ç»™é›ªä½›å…°å»è§£æï¼š

```javascript
;(function jsonGrammarOnlyExample() {
  // ----------------- Lexer -----------------
  const createToken = chevrotain.createToken
  const Lexer = chevrotain.Lexer

  const NumberMark = createToken({
    name: 'NumberMark',
    pattern: /-?\d*\.?\d+/,
  })

  const AddMark = createToken({
    name: 'AddMark',
    pattern: /\+/,
  })

  const AddTokens = [NumberMark, AddMark]

  const AddLexer = new Lexer(AddTokens, {
    // Less position info tracked, reduces verbosity of the playground output.
    positionTracking: 'onlyStart',
  })

  // for the playground to work the returned object must contain these fields
  return {
    lexer: AddLexer,
  }
})()
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°å­—å’ŒåŠ å·éƒ½è¢«æ­£å¸¸çš„è§£æå‡ºæ¥äº†ã€‚

éšåï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹å…·ä½“çš„åŠ å·åŠŸèƒ½ï¼š

```javascript
;(function calculatorExample() {
  // ----------------- lexer -----------------
  const createToken = chevrotain.createToken
  const tokenMatcher = chevrotain.tokenMatcher
  const Lexer = chevrotain.Lexer
  const EmbeddedActionsParser = chevrotain.EmbeddedActionsParser

  const Plus = createToken({ name: 'Plus', pattern: /\+/ })

  const Number = createToken({ name: 'Number', pattern: /[1-9]\d*/ })

  // whitespace is normally very common so it is placed first to speed up the lexer
  const allTokens = [Plus, Number]
  const CalculatorLexer = new Lexer(allTokens)

  class Calculator extends EmbeddedActionsParser {
    constructor() {
      super(allTokens)

      const $ = this

      $.RULE('additionExpression', () => {
        let value, op, rhsVal

        value = parseInt($.CONSUME(Number).image)
        op = $.CONSUME(Plus)
        rhsVal = parseInt($.CONSUME2(Number).image)
        value += rhsVal
        return value
      })
      this.performSelfAnalysis()
    }
  }

  // for the playground to work the returned object must contain these fields
  return {
    lexer: CalculatorLexer,
    parser: Calculator,
    defaultRule: 'additionExpression',
  }
})()
```

æ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿæ€»ä½“æ¥çœ‹ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰äº†ä¸¤ä¸ª tokenï¼Œä¸€ä¸ªæ˜¯æ•°å­—çš„ï¼Œä¸€ä¸ªæ˜¯ add æ“ä½œç¬¦çš„ï¼Œéšåæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª RULEï¼Œå…ˆæ¶ˆè´¹(\$.CONSUME)äº†ä¸€ä¸ªæ•°å­—ï¼Œç„¶åå†æ¶ˆè´¹äº†åŠ å· Plusï¼Œå†æ¶ˆè´¹äº†ä¸€ä¸ªæ•°å­—ã€‚é›ªä½›å…°ä¼šæ ¹æ®è¿™å¥—è§„åˆ™å»è¯•ç€çœ‹èƒ½ä¸èƒ½æ¶ˆè´¹çš„äº†ï¼Œå¦‚æœå¯ä»¥åˆ™ä¼šä¸€è¡Œä¸€è¡Œæ‰§è¡Œä¸‹å»ï¼Œæœ€ç»ˆå®Œæˆæˆ‘ä»¬çš„`value += rhsVal`ç„¶åæˆ‘ä»¬æŠŠå€¼ return å‡ºå»å°±å®Œæˆäº†åŠ æ³•ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªå•ä½æ˜¯å­—ç¬¦ä¸²æˆ–è€…ç¬¬äºŒä¸ªç¬¦å·æ˜¯ \*ï¼Œåˆ™ä»–ä¼šæŠ¥é”™ï¼š

![](image/image_cXPGtP5fuN.png)

![](image/image_hd04OMtNnT.png)

é‚£æ¥ä¸‹æ¥å°±å¾ˆç®€å•å•¦ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‰©ä¸‹æ¥çš„ token è¡¥ä¸Šå³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬å†ç¼–å†™ä¸€å¥—ä¹˜æ³•çš„è§„åˆ™ï¼š

```javascript
;(function calculatorExample() {
  // ----------------- lexer -----------------
  const createToken = chevrotain.createToken
  const tokenMatcher = chevrotain.tokenMatcher
  const Lexer = chevrotain.Lexer
  const EmbeddedActionsParser = chevrotain.EmbeddedActionsParser

  const Plus = createToken({ name: 'Plus', pattern: /\+/ })
  const Mut = createToken({ name: 'Mut', pattern: /\*/ })

  const Number = createToken({ name: 'Number', pattern: /[1-9]\d*/ })

  // whitespace is normally very common so it is placed first to speed up the lexer
  const allTokens = [Plus, Number, Mut]
  const CalculatorLexer = new Lexer(allTokens)

  class Calculator extends EmbeddedActionsParser {
    constructor() {
      super(allTokens)

      const $ = this
      $.RULE('value', () => {
        let val
        $.OR([
          { ALT: () => (val = $.SUBRULE($.additionExpression)) },
          { ALT: () => (val = $.SUBRULE($.mutExpression)) },
        ])
        return val
      })

      $.RULE('additionExpression', () => {
        let value, op, rhsVal

        value = parseInt($.CONSUME(Number).image)
        op = $.CONSUME(Plus)
        rhsVal = parseInt($.CONSUME2(Number).image)
        value += rhsVal
        return value
      })
      $.RULE('mutExpression', () => {
        let value, op, rhsVal

        value = parseInt($.CONSUME(Number).image)
        op = $.CONSUME(Mut)
        rhsVal = parseInt($.CONSUME2(Number).image)
        value *= rhsVal
        return value
      })
      this.performSelfAnalysis()
    }
  }

  // for the playground to work the returned object must contain these fields
  return {
    lexer: CalculatorLexer,
    parser: Calculator,
    defaultRule: 'value',
  }
})()
```

å¥½ï¼Œé‚£ä¹ˆç°åœ¨é—®é¢˜æ¥äº†ï¼Œç°åœ¨åªèƒ½åšå•ä¸ªåŠ å‡ä¹˜é™¤çš„è¿ç®—ï¼Œå¦‚ä½•æ”¯æŒ`1+2*3`è¿™æ ·çš„ä¸œè¥¿å‘¢?

åœ¨é›ªä½›å…°çš„ä¸–ç•Œé‡Œï¼Œå¯¹äºè¾“å…¥å†…å®¹çš„è§£æï¼Œä»–æ˜¯ä¾é [LL grammar - Wikipedia](https://en.wikipedia.org/wiki/LL_grammar 'LL grammar - Wikipedia') è¯­æ³•è§„åˆ™è¿›è¡Œè§£æçš„ï¼Œè¿™ä¸ªè§„åˆ™éå¸¸å¤æ‚æˆ‘ä»¬ä¸åœ¨è¿™é‡Œåšè¿‡å¤šæ·±å…¥ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ï¼š

ä»å·¦è‡³å³ï¼Œåˆ†ææ¯ä¸ªè¯æ³•çš„å³éƒ¨å†…å®¹ï¼Œä¸”ä¸€å±‚ä¸€å±‚é€’å½’åˆ†æã€‚

æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼š

å‡è®¾è¦åˆ†æ`1+2*3`

å¯¹äºæˆ‘ä»¬ç¼–å†™çš„é›ªä½›å…°ç¨‹åºæ¥è¯´ï¼Œä»–åº”è¯¥å…ˆæŠŠ 1 æ¶ˆè´¹æ‰ï¼Œç„¶åæš‚æ—¶æŠŠ 1 å­˜ä¸‹æ¥ï¼ŒæŠŠ+ä¹Ÿå­˜ä¸‹æ¥ï¼Œç„¶åæ¥ç€å»åˆ†æ`2*3`,åˆ°äº† 2 è¿™é‡Œï¼ŒåŒæ ·ä¹Ÿæ˜¯æŠŠ 2 å­˜ä¸‹æ¥ï¼Œ\*å­˜ä¸‹æ¥ï¼Œå»åˆ†æ 3ï¼Œå¦‚æœåé¢è¿˜æœ‰ä¸œè¥¿ï¼Œå°±åº”è¯¥ä¾æ¬¡å¾€ä¸‹é€’å½’ï¼Œç›´åˆ°æœ€åº•å±‚ä»–å·²ç»è§£æå®Œæˆäº†ï¼Œå†ä¸€å±‚ä¸€å±‚å¾€ä¸ŠæŠŠç»“æœæŠ›å›å»ï¼Œä¸Šå±‚æ‹¿åˆ°ç»“æœä»¥åæ‰§è¡Œè‡ªå·±çš„é€»è¾‘å†æŠŠå€¼æŠ›ç»™ä»–çš„ä¸Šå±‚ï¼Œè¿™é‡Œæœ‰ç‚¹åƒæˆ‘ä»¬ç¨‹åºé‡Œçš„æ ˆï¼ˆå…ˆè¿›åå‡ºï¼‰æ¦‚å¿µã€‚

æˆ‘ä»¬å†æ¥ä¸¾ä¸ªå®é™…çš„æ —å­ï¼Œä¸‹é¢çš„ä¾‹å­åœ¨ç¨‹åºä¸­ä¸æ˜¯æ­£ç¡®çš„ï¼Œä½†èƒ½å¾ˆå¥½åœ°è¡¨è¾¾ LL çš„æ€æƒ³ï¼š

```çº¯æ–‡æœ¬
1+2*3+4-5
// ç¨‹åºçš„æ‰§è¡Œé€»è¾‘ä¼šæ˜¯è¿™æ ·ï¼š
// å…ˆæ ‡è®°1å’Œ+ï¼Œç„¶åå­˜ä¸‹æ¥ï¼Œç„¶åå»åˆ†æ2*3+4-5
// å†æ ‡è®°2å’Œ*ï¼Œå­˜ä¸‹æ¥ï¼Œç„¶åå»åˆ†æ3+4-5
// å†æ ‡è®°3å’Œ+ï¼Œå­˜ä¸‹æ¥ï¼Œç„¶åå»åˆ†æ4-5
// å†æ ‡è®°4å’Œ-ï¼Œå­˜ä¸‹æ¥ï¼Œç„¶åå»åˆ†æ5
// åˆ°äº†5è¿™é‡Œï¼Œ5çš„å³è¾¹å·²ç»æ²¡æœ‰ä¸œè¥¿äº†ï¼Œæ‰€ä»¥ç›´æ¥return 5
// 4çš„é‚£ä¸€å±‚è§„åˆ™æ¥æ”¶åˆ°äº†5çš„returnï¼Œå¼€å§‹æ‰§è¡Œ4-5=-1ï¼Œç„¶åæŠŠ-1 return å‡ºå»
// 3çš„é‚£ä¸€å±‚æ¥æ”¶åˆ°äº†-1ï¼Œè®¡ç®—3+-1ï¼Œå¾—åˆ°2ï¼Œç„¶åæŠŠ2 return å‡ºå»
// 2çš„é‚£ä¸€å±‚æ¥æ”¶åˆ°äº†2ï¼Œè®¡ç®—2*2ï¼Œå¾—åˆ°4ï¼ŒæŠŠ4 return å‡ºå»
// 1çš„é‚£ä¸€å±‚æ¥æ”¶åˆ°äº†4ï¼Œè®¡ç®—1+4 å¾—5ï¼Œæœ€ç»ˆæ•´ä¸ªç¨‹åºreturnå‡ºå»äº†ä¸€ä¸ª5.
```

å¥½ï¼Œåˆ°è¿™é‡Œå¤§å®¶ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è§„åˆ™ï¼Œå…¶å®æˆ‘ä»¬è¿™ä¸ªç®—å‡ºæ¥çš„ç»“æœæ˜¯é”™çš„ï¼Œå› ä¸ºæ•°å­¦æ˜¯å…ˆä¹˜é™¤ååŠ å‡ï¼Œæ­£å¸¸`1+2*3+4-5`æ‰€ä»¥è¿™é‡Œä¼šæœ‰ä¸€ä¸ª**è§„åˆ™ä¼˜å…ˆçº§**çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¸€èµ·å®Œå–„ä¸‹æ•´ä¸ªç¨‹åºå°±çŸ¥é“å¦‚ä½•å®šä¹‰è¿™ä¸ªä¼˜å…ˆçº§äº†ï¼š

```javascript
;(function calculatorExample() {
  // ----------------- lexer -----------------
  const createToken = chevrotain.createToken
  const tokenMatcher = chevrotain.tokenMatcher
  const Lexer = chevrotain.Lexer
  const EmbeddedActionsParser = chevrotain.EmbeddedActionsParser

  // using the NA pattern marks this Token class as 'irrelevant' for the Lexer.
  // AdditionOperator defines a Tokens hierarchy but only leafs in this hierarchy
  // define actual Tokens that can appear in the text
  const AdditionOperator = createToken({ name: 'AdditionOperator', pattern: Lexer.NA })
  const Plus = createToken({ name: 'Plus', pattern: /\+/, categories: AdditionOperator })
  const Minus = createToken({ name: 'Minus', pattern: /-/, categories: AdditionOperator })

  const MultiplicationOperator = createToken({ name: 'MultiplicationOperator', pattern: Lexer.NA })
  const Multi = createToken({ name: 'Multi', pattern: /\*/, categories: MultiplicationOperator })
  const Div = createToken({ name: 'Div', pattern: /\//, categories: MultiplicationOperator })

  const NumberLiteral = createToken({ name: 'NumberLiteral', pattern: /[1-9]\d*/ })

  const WhiteSpace = createToken({
    name: 'WhiteSpace',
    pattern: /\s+/,
    group: Lexer.SKIPPED,
  })

  // whitespace is normally very common so it is placed first to speed up the lexer
  const allTokens = [
    WhiteSpace,
    Plus,
    Minus,
    Multi,
    Div,
    NumberLiteral,
    AdditionOperator,
    MultiplicationOperator,
  ]
  const CalculatorLexer = new Lexer(allTokens)

  class Calculator extends EmbeddedActionsParser {
    constructor() {
      super(allTokens)
      const $ = this
      $.RULE('additionExpression', () => {
        let value, op, rhsVal
        // parsing part
        value = $.SUBRULE($.multiplicationExpression)
        console.log('additionExpression, left-value:', value)
        $.MANY(() => {
          op = $.CONSUME(AdditionOperator)
          console.log('additionExpression, op:', op)
          rhsVal = $.SUBRULE2($.multiplicationExpression)
          console.log('additionExpression, right-value:', rhsVal)
          if (tokenMatcher(op, Plus)) {
            value += rhsVal
            console.log('additionExpression, a+b:', value)
          } else {
            value -= rhsVal
            console.log('additionExpression, a-b:', value)
          }
        })

        return value
      })

      $.RULE('multiplicationExpression', () => {
        let value, op, rhsVal

        // parsing part
        value = parseInt($.CONSUME(NumberLiteral).image, 10)
        console.log('multiplicationExpression, left-value:', value)

        $.MANY(() => {
          op = $.CONSUME(MultiplicationOperator)
          console.log('multiplicationExpression, op:', op)
          rhsVal = parseInt($.CONSUME2(NumberLiteral).image, 10)
          console.log('multiplicationExpression, rhsVal:', rhsVal)
          if (tokenMatcher(op, Multi)) {
            value *= rhsVal
            console.log('multiplicationExpression, a*b:', value)
          } else {
            value /= rhsVal
            console.log('multiplicationExpression, a/b:', value)
          }
        })

        return value
      })

      this.performSelfAnalysis()
    }
  }

  return {
    lexer: CalculatorLexer,
    parser: Calculator,
    defaultRule: 'additionExpression',
  }
})()
```

å¥½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å»è¡¥å……ä¸‹é¢è¿™å‡ ç§æƒ…å†µï¼š

- æ¯”è¾ƒç¬¦

- æ‹¬å·è¡¨è¾¾å¼

- å˜é‡

- å‡½æ•°

- æ•°ç»„

ä»£ç å¤ªå¤šï¼Œè¿™é‡Œç›´æ¥ç»™å¤§å®¶è®²åŸç ï¼š

[Hansuku/super-formula: a formula realize, work with form-formula or excel-formula. (github.com)](https://github.com/Hansuku/super-formula 'Hansuku/super-formula: a formula realize, work with form-formula or excel-formula. (github.com)')

æœ€åç»™å¤§å®¶æ¥ä¸ªå°å½©è›‹å§ï¼Œ

æˆ‘ä»¬å†™ä¸€ä¸ªç±»ä¼¼æ–‡è¨€æ–‡ç¼–ç¨‹çš„ parserï¼š

[wenyan-lang/wenyan: æ–‡è¨€æ–‡ç·¨ç¨‹èªè¨€ A programming language for the ancient Chinese. (github.com)](https://github.com/wenyan-lang/wenyan 'wenyan-lang/wenyan: æ–‡è¨€æ–‡ç·¨ç¨‹èªè¨€ A programming language for the ancient Chinese. (github.com)')

```javascript
;(function calculatorExample() {
  // ----------------- lexer -----------------
  const createToken = chevrotain.createToken
  const tokenMatcher = chevrotain.tokenMatcher
  const Lexer = chevrotain.Lexer
  const EmbeddedActionsParser = chevrotain.EmbeddedActionsParser

  // using the NA pattern marks this Token class as 'irrelevant' for the Lexer.
  // AdditionOperator defines a Tokens hierarchy but only leafs in this hierarchy
  // define actual Tokens that can appear in the text
  const Var = createToken({ name: 'Var', pattern: /ä»Šæœ‰ä¸€äººï¼Œåæ›°/ })
  const Comma = createToken({ name: 'Comma', pattern: /ï¼Œ/ })
  const Point = createToken({ name: 'Point', pattern: /ã€‚/ })
  const It = createToken({ name: 'It', pattern: /å…¶/ })

  const MarkYearsOld = createToken({ name: 'MarkYearsOld', pattern: /ä¹‹å¤§ï¼Œ/ })
  const MarkIt = createToken({ name: 'MarkIt', pattern: /æ˜¯ä¹Ÿ/ })

  const keySum = createToken({ name: 'KeySum', pattern: Lexer.NA })
  const old = createToken({ name: 'old', pattern: /å¹´å²/, categories: keySum })
  const skill = createToken({ name: 'skill', pattern: /ç¥é€š/, categories: keySum })

  const StringMark = createToken({
    name: 'StringMark',
    pattern: /â€œ[\u4e00-\u9fa5a-zA-Z0-9=><!']+â€/,
  })

  const BR = createToken({
    name: 'BR',
    pattern: /\n+/,
  })
  // whitespace is normally very common so it is placed first to speed up the lexer
  const allTokens = [
    Var,
    Comma,
    Point,
    MarkYearsOld,
    MarkIt,
    StringMark,
    It,
    keySum,
    old,
    skill,
    BR,
  ]
  const CalculatorLexer = new Lexer(allTokens)

  const person = {}
  class Calculator extends EmbeddedActionsParser {
    constructor() {
      super(allTokens)

      const $ = this

      $.RULE('VarOp', () => {
        $.CONSUME(Var)
        person['å§“å'] = $.CONSUME(StringMark).image
        $.CONSUME(Point)
        $.CONSUME(BR)
        $.MANY_SEP({
          SEP: BR,
          DEF: () => {
            this.SUBRULE(this.KeyOp)
          },
        })
        return person
      })

      $.RULE('KeyOp', () => {
        $.CONSUME(It)
        let key = $.CONSUME(keySum)
        console.log(key)
        $.CONSUME(MarkYearsOld)
        let value = $.CONSUME(StringMark)
        $.CONSUME(MarkIt)
        $.CONSUME(Point)
        this.ACTION(() => {
          person[key.image] = value.image
        })
      })

      // very important to call this after all the rules have been defined.
      // otherwise the parser may not work correctly as it will lack information
      // derived during the self analysis phase.
      this.performSelfAnalysis()
    }
  }

  // for the playground to work the returned object must contain these fields
  return {
    lexer: CalculatorLexer,
    parser: Calculator,
    defaultRule: 'VarOp',
  }
})()
```

```çº¯æ–‡æœ¬
ä»Šæœ‰ä¸€äººï¼Œåæ›°â€œè”¡å¾å¤â€ã€‚
å…¶å¹´å²ä¹‹å¤§ï¼Œâ€œäºŒåä¸‰â€æ˜¯ä¹Ÿã€‚
å…¶ç¥é€šä¹‹å¤§ï¼Œâ€œå”±è·³RAPç¯®çƒâ€æ˜¯ä¹Ÿã€‚
```

å¤§å®¶å¯ä»¥è¯•è¯•è¿™æ®µä¼šè¾“å‡ºä»€ä¹ˆï¼ŸğŸ‰
